---
layout: layouts/shop-php-page.njk
title: Cart
description: Your Floriade shopping cart
header_image: "/v1606787440/site/floriade-dried-flower-room-00001.jpg"
header:
  title: Your Cart
permalink: "cart/index.php"
---

<style>
#items {
  display:grid;
  grid-template-columns:1fr auto;
  align-items:start;
}
#items > * {
  width:100%;
  height:100%;
  padding:0.5em;
}
#items > * + *, .top-border {
  border-top:1px solid rgba(255, 255, 255, 0.1);
}
#items > *:nth-child(2) {
  border-top:none;
}
#summary {
  display:grid;
  grid-template-columns:1fr auto auto;
  align-items:center;
}
#summary > *:not(select) {
  width:100%;
  height:100%;
  padding:0.5em;
}
</style>

<?php
  $timeout = microtime(true) - $cart_expiry_time;

  $cart_expired = false;

  foreach($_SESSION["cart"] as $cart_item) {
    if(isset($cart_item["stock-id"])) {
      $stock_item = $stockStore->findOneBy(["stock-id", "=", $cart_item["stock-id"]]);
      if(($cart_item["updated"] < $timeout) || ($cart_item["updated"] < $stock_item["updated"])) {
        $cart_expired = true;
      }
    }
  }

  if($cart_expired) {
    foreach($_SESSION["cart"] as $cart_item) {
      if(isset($cart_item["stock-id"])) {
        $stock_item = $stockStore->findOneBy(["stock-id", "=", $cart_item["stock-id"]]);
        if($cart_item["updated"] == $stock_item["updated"]) {
          $stock_item["updated"] = microtime(true) - $cart_reset_time;
          $stockStore->update($stock_item);
        }
      }
    }

    unset($_SESSION["cart"]);
    unset($_SESSION["payment-intent-id"]);
    $_SESSION["cart"] = array();
    $_SESSION["error"] = "Your session has timed out";
  }
?>

<?php
  $i = 0;
  $count = 0;
  foreach($_SESSION["cart"] as $cart_item) {
    if(!cartHasParents($cart_item["product-id"])) {
      if(isset($cart_item["stock-id"])) {
        $stock_item = $stockStore->findOneBy(["stock-id", "=", $cart_item["stock-id"]]);
        if($cart_item["updated"] == $stock_item["updated"]) {
          $stock_item["updated"] = microtime(true) - $cart_reset_time;
          $stockStore->update($stock_item);
        }
      }
      array_splice($_SESSION["cart"], $i, 1);
      $count++;
    } else {
      $i++;
    }
  }

  if($count) {
    $_SESSION["info"] .= "<br>" . (($count > 1) ? ($count . " add-on items were") : "1 add-on item was") . " removed from your cart";
  }
?>

<noscript>
<aside class="banner-error">
Javascript is currently disabled in your web browser. The online shop cannot function properly unless Javascript is enabled. Learn how to <a target="_blank" title="Opens in a new page" href="http://www.enable-javascript.com/" style="text-decoration:underline">enable Javascript</a> in your web browser.
</aside>
</noscript>

<div id="info-wrapper" class="stack" style="display:none;margin-top:calc(var(--section-padding)/2)">
    <p id="info" class="info"></p>
</div>

<section id="cart" style="min-height:50vh">
  <div class="wrapper text-wrapper">
    <?php $cart_count = count($_SESSION["cart"]); ?>
    <?php $cart_total = 0; ?>
    <?php $delivery_fee = 0; ?>

    <div id="empty-cart" class="center-both stack" style="display:none;--stack-space:2em">
      <h2 class="heading">Your Cart is Empty</h2>
      <p id="cart-expired" class="font-secondary" style="display:none">Your session has timed out</p>
      <div class="text-center">
        <a class="button icon-button" href="/shop/">
          <span>{{ '/src/svg/arrow-left.svg' | svgContents | safe }}</span><p>Continue Shopping</p>
        </a>
      </div>
    </div>

    <form id="cart-form" action="/checkout/" method="post" class="flow" style="display:none;width:100%;--flow-space:2em">
      <hr />
      <div id="items" class="font-secondary"></div>
      <hr />
      <div id="summary" class="text-right font-secondary"></div>
      <hr />

      <input id="return-url" name="return-url" type="hidden" value="{{ page.url | cleanUrl }}" style="margin:0">

      <div class="buttons swap">
        <a class="button icon-button" href="/shop/">
          <span>{{ '/src/svg/arrow-left.svg' | svgContents | safe }}</span><p>Continue Shopping</p>
        </a>
        <button class="icon-button cursor-pointer bigfonts" type="submit">
          <span>{{ '/src/svg/shopping-cart.svg' | svgContents | safe }}</span><p>Checkout</p>
        </button>
      </div>
      <div class="stack center">
        <span id="error-msg" class="error" style="visibility:hidden">&nbsp;</span>
      </div>
    </form>
    </div>
</section>

<script>
var cart_total = 0;

document.addEventListener("DOMContentLoaded",function(){
  showInfo();
  displayCart();
});

function showInfo() {
  var info = localStorage.getItem("floriade-cart-info") || "";
  if(info !== "") {
    document.getElementById("info").innerText = info;
    document.getElementById("info-wrapper").style.display = "flex";
    localStorage.removeItem("floriade-cart-info");
  }
}

function displayCart() {
  var cart = JSON.parse(localStorage.getItem("floriade-cart")) || [];
  var expired = false;
  var timeout = microtime(true) - 1200.0;

  cart.forEach(item => {
    if((item.updated) && (item.updated < timeout)) {
      expired = true;
    }
  });

  if(expired) {
    document.getElementById("cart-expired").style.display = "block";
    localStorage.removeItem("floriade-cart");
    cart = [];
  }

  if(cart.length === 0) {
    document.getElementById("empty-cart").style.display = "flex";
    return;
  }

  console.log("DS " + localStorage.getItem("floriade-delivery-suburb"));

  fetch("/php/display-cart.php", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      "cart": cart,
      "delivery-suburb": localStorage.getItem("floriade-delivery-suburb")
    })
  })
    .then(response => {
      if(!response.ok) {
        showError(response.statusText);
        throw Error(response.statusText);
      } else {
        return response.json();
      }
    })
    .then(json => {
      if(json.error) {
        showError(json.error);
        return;
      } else {
        document.getElementById("items").innerHTML = json["cart-items"];
        document.getElementById("summary").innerHTML = json["cart-summary"];
        cart_total = parseInt(json["cart-total"]);
      }
    });

  document.getElementById("cart-form").style.display = "block";
}

function formatMoney(price) {
  if(price == 0) { return 'free'; }
  if(Math.floor(price) == (price)) {
    return '$' + (price);
  } else {
    return '$' + (price).toFixed(2);
  }
}

function updateDeliveryFee() {
  var suburb = document.getElementById("delivery-suburb").value;
  localStorage.setItem("floriade-delivery-suburb", suburb);

  fetch("/php/delivery-fee.php", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      "delivery-suburb": suburb
    })
  })
    .then(response => {
      if(!response.ok) {
        showError(response.statusText);
        throw Error(response.statusText);
      } else {
        return response.json();
      }
    })
    .then(json => {
      if(json.error) {
        showError(json.error);
        return;
      } else {
        var delivery_fee = parseInt(json["delivery-fee"]);
        document.getElementById("delivery-fee").innerHTML = formatMoney(delivery_fee);
        document.getElementById("total").innerHTML = formatMoney(delivery_fee + cart_total);
      }
    });
}

</script>
